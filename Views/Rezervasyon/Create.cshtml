@model VipTransfer.Web.Models.ViewModels.RezervasyonViewModel
@{
    ViewData["Title"] = "Yeni Rezervasyon";
}

<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">@ViewData["Title"]</h1>
    
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="bg-blue-700 p-6 text-white">
            <h2 class="text-xl font-semibold">Transfer Bilgileri</h2>
            <p class="mt-2 text-blue-100">Lütfen transfer detaylarını girin</p>
        </div>
        
        <div class="p-6">
            <form asp-action="Create" method="post" id="rezervasyonForm">
                <div asp-validation-summary="ModelOnly" class="text-red-600 mb-4"></div>
                
                <!-- Transfer Bilgileri -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label asp-for="Nereden" class="block text-gray-700 text-sm font-medium mb-2">Nereden</label>
                        <input asp-for="Nereden" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Başlangıç noktası">
                        <span asp-validation-for="Nereden" class="text-sm text-red-600"></span>
                    </div>
                    
                    <div>
                        <label asp-for="Nereye" class="block text-gray-700 text-sm font-medium mb-2">Nereye</label>
                        <input asp-for="Nereye" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Varış noktası">
                        <span asp-validation-for="Nereye" class="text-sm text-red-600"></span>
                    </div>
                    
                    <div>
                        <label asp-for="RezervasyonTarihi" class="block text-gray-700 text-sm font-medium mb-2">Tarih</label>
                        <input asp-for="RezervasyonTarihi" type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" min="@DateTime.Now.ToString("yyyy-MM-dd")">
                        <span asp-validation-for="RezervasyonTarihi" class="text-sm text-red-600"></span>
                    </div>
                    
                    <div>
                        <label asp-for="RezervasyonSaati" class="block text-gray-700 text-sm font-medium mb-2">Saat</label>
                        <input asp-for="RezervasyonSaati" type="time" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <span asp-validation-for="RezervasyonSaati" class="text-sm text-red-600"></span>
                    </div>
                    
                    <div>
                        <label asp-for="UcusNo" class="block text-gray-700 text-sm font-medium mb-2">Uçuş Numarası (Opsiyonel)</label>
                        <input asp-for="UcusNo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Uçuş numarası">
                        <span asp-validation-for="UcusNo" class="text-sm text-red-600"></span>
                    </div>
                </div>
                
                <!-- Araç Seçimi -->
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Araç Seçimi</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    @if (Model.AracListesi != null && Model.AracListesi.Any())
                    {
                        @foreach (var arac in Model.AracListesi)
                        {
                            <div class="border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-500 transition" 
                                 onclick="selectVehicle('@arac.ARACGUID', this)">
                                <input type="radio" name="SeciliAracGUID" value="@arac.ARACGUID" class="hidden vehicle-radio">
                                <div class="flex flex-col items-center">
                                    <div class="bg-blue-100 rounded-full p-4 mb-3">
                                        @if (arac.TIP == 1)
                                        {
                                            <i class="fas fa-car text-3xl text-blue-700"></i>
                                        }
                                        else if (arac.TIP == 2)
                                        {
                                            <i class="fas fa-car-side text-3xl text-blue-700"></i>
                                        }
                                        else if (arac.TIP == 3)
                                        {
                                            <i class="fas fa-shuttle-van text-3xl text-blue-700"></i>
                                        }
                                        else
                                        {
                                            <i class="fas fa-bus text-3xl text-blue-700"></i>
                                        }
                                    </div>
                                    <h4 class="font-semibold text-center">@arac.MARKA @arac.MODEL</h4>
                                    <p class="text-sm text-gray-500 text-center">@arac.PLAKA</p>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="col-span-4 text-center text-gray-500 py-4">Araç bulunamadı.</p>
                    }
                </div>
                
                <span id="aracSecimHata" class="text-sm text-red-600 mb-4 hidden">Lütfen bir araç seçin</span>
                
                <!-- Ücret Bilgisi -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Ücret Bilgisi</h3>
                    
                    <div class="flex flex-col gap-2 mb-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tahmini Mesafe:</span>
                            <span id="tahminiMesafe" class="font-semibold">0 km</span>
                            <input asp-for="TahminiKm" type="hidden" value="0">
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Transfer Ücreti:</span>
                            <span id="transferUcreti" class="font-semibold">0 ₺</span>
                            <input asp-for="Ucret" type="hidden" value="0">
                        </div>
                    </div>
                    
                    <button type="button" id="hesaplaBtn" class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition">
                        Ücreti Hesapla
                    </button>
                </div>
                
                <!-- Onay Butonu -->
                <div>
                    <button type="submit" id="submitBtn" class="w-full bg-blue-700 text-white text-center py-3 rounded-lg font-semibold hover:bg-blue-800 transition">
                        Rezervasyonu Oluştur
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        // Araç seçimi
        function selectVehicle(aracGuid, element) {
            // Tüm seçimleri kaldır
            document.querySelectorAll('.vehicle-radio').forEach(radio => {
                radio.checked = false;
                radio.closest('div').classList.remove('border-blue-500', 'bg-blue-50');
                radio.closest('div').classList.add('border-gray-200');
            });
            
            // Seçilen aracı işaretle
            element.querySelector('.vehicle-radio').checked = true;
            element.classList.remove('border-gray-200');
            element.classList.add('border-blue-500', 'bg-blue-50');
            
            // Araç seçim hatasını gizle
            document.getElementById('aracSecimHata').classList.add('hidden');
        }
        
        // Ücret hesaplama
        document.getElementById('hesaplaBtn').addEventListener('click', function() {
            const nereden = document.getElementById('Nereden').value;
            const nereye = document.getElementById('Nereye').value;
            const seciliArac = document.querySelector('.vehicle-radio:checked');
            
            if (!nereden || !nereye) {
                alert('Lütfen nereden ve nereye bilgilerini girin.');
                return;
            }
            
            if (!seciliArac) {
                document.getElementById('aracSecimHata').classList.remove('hidden');
                return;
            }
            
            const aracGuid = seciliArac.value;
            
            // AJAX isteği ile fiyat hesapla
            fetch('/Rezervasyon/CalculatePrice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `nereden=${encodeURIComponent(nereden)}&nereye=${encodeURIComponent(nereye)}&aracGuid=${encodeURIComponent(aracGuid)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('tahminiMesafe').textContent = data.mesafe + ' km';
                    document.getElementById('transferUcreti').textContent = data.ucret + ' ₺';
                    document.getElementById('TahminiKm').value = data.mesafe;
                    document.getElementById('Ucret').value = data.ucret;
                } else {
                    alert(data.message || 'Ücret hesaplanamadı, lütfen tekrar deneyin.');
                }
            })
            .catch(error => {
                console.error('Hata:', error);
                alert('Ücret hesaplanırken bir hata oluştu, lütfen tekrar deneyin.');
            });
        });
        
        // Form gönderme kontrolü
        document.getElementById('rezervasyonForm').addEventListener('submit', function(event) {
            const seciliArac = document.querySelector('.vehicle-radio:checked');
            
            if (!seciliArac) {
                event.preventDefault();
                document.getElementById('aracSecimHata').classList.remove('hidden');
                return false;
            }
            
            if (document.getElementById('Ucret').value <= 0) {
                event.preventDefault();
                alert('Lütfen önce ücreti hesaplayın.');
                return false;
            }
            
            return true;
        });
    </script>
}